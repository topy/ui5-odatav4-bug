/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_AggregationHelper","./_Cache","./_GrandTotalHelper","./_GroupLock","./_Helper","./_MinMaxHelper","sap/base/Log","sap/ui/base/SyncPromise"],function(e,t,n,r,i,a,o,l){"use strict";function s(r,a,o,s,u){var d=this;t.call(this,r,a,u,true);if(o.groupLevels.length){if(u.$count){throw new Error("Unsupported system query option: $count")}if(u.$filter){throw new Error("Unsupported system query option: $filter")}}this.oAggregation=o;this.aElements=[];this.aElements.$byPredicate={};this.aElements.$count=undefined;this.aElements.$created=0;this.oFirstLevel=this.createGroupLevelCache(null,s);this.oGrandTotalPromise=undefined;if(s){this.oGrandTotalPromise=new l(function(t){n.enhanceCacheWithGrandTotal(d.oFirstLevel,o,function(n){var r;e.setAnnotations(n,true,true,0,e.getAllProperties(o));if(o.grandTotalAtBottomOnly===false){r=Object.assign({},n,{"@$ui5.node.isExpanded":undefined});i.setPrivateAnnotation(n,"copy",r);i.setPrivateAnnotation(r,"predicate","($isTotal=true)")}i.setPrivateAnnotation(n,"predicate","()");t(n)})})}}s.prototype=Object.create(t.prototype);s.prototype.addElements=function(e,t,n,r){var a=this.aElements;function o(e,o){var l=a[t+o],s,u=i.getPrivateAnnotation(e,"predicate");if(l){if(l===e){return}s=i.getPrivateAnnotation(l,"parent");if(!s){throw new Error("Unexpected element")}if(s!==n||i.getPrivateAnnotation(l,"index")!==r+o){throw new Error("Wrong placeholder")}}else if(t+o>=a.length){throw new Error("Array index out of bounds: "+(t+o))}if(u in a.$byPredicate&&a.$byPredicate[u]!==e){throw new Error("Duplicate predicate: "+u)}a[t+o]=e;a.$byPredicate[u]=e}if(t<0){throw new Error("Illegal offset: "+t)}if(Array.isArray(e)){e.forEach(o)}else{o(e,0)}};s.prototype.collapse=function(e){var t=0,n=this.aElements,a=this.fetchValue(r.$cached,e).getResult(),o=a["@$ui5.node.level"],l=n.indexOf(a),s=l+1;function u(e){delete n.$byPredicate[i.getPrivateAnnotation(n[e],"predicate")];t+=1}i.updateAll(this.mChangeListeners,e,a,i.getPrivateAnnotation(a,"collapsed"));while(s<n.length&&n[s]["@$ui5.node.level"]>o){u(s);s+=1}if(this.oAggregation.subtotalsAtBottomOnly!==undefined){u(s)}i.setPrivateAnnotation(a,"spliced",n.splice(l+1,t));n.$count-=t;return t};s.prototype.createGroupLevelCache=function(n,r){var a=this.oAggregation,o=e.getAllProperties(a),l,u,d,c,f,g,h;f=n?n["@$ui5.node.level"]+1:1;c=f>a.groupLevels.length;d=c?a.groupLevels.concat(Object.keys(a.group).sort()):a.groupLevels.slice(0,f);g=Object.assign({},this.mQueryOptions);u=e.filterOrderby(g.$orderby,a,f);if(u){g.$orderby=u}else{delete g.$orderby}h=!c&&Object.keys(a.aggregate).some(function(e){return a.aggregate[e].subtotals});if(n){g.$$filterBeforeAggregate=i.getPrivateAnnotation(n,"filter")+(g.$$filterBeforeAggregate?" and ("+g.$$filterBeforeAggregate+")":"")}if(!r){delete g.$count;g=e.buildApply(a,g,f)}g.$count=true;l=t.create(this.oRequestor,this.sResourcePath,g,true);l.calculateKeyPredicate=s.calculateKeyPredicate.bind(null,n,d,o,c,h);return l};s.prototype.expand=function(t,n){var a,o,s=typeof n==="string"?this.fetchValue(r.$cached,n).getResult():n,u=i.getPrivateAnnotation(s,"spliced"),d=this;if(n!==s){i.updateAll(this.mChangeListeners,n,s,e.getOrCreateExpandedObject(this.oAggregation,s))}if(u){i.deletePrivateAnnotation(s,"spliced");this.aElements.splice.apply(this.aElements,[this.aElements.indexOf(s)+1,0].concat(u));o=u.length;this.aElements.$count+=o;u.forEach(function(e){var t=i.getPrivateAnnotation(e,"predicate");if(t){d.aElements.$byPredicate[t]=e;if(i.getPrivateAnnotation(e,"expanding")){i.deletePrivateAnnotation(e,"expanding");o+=d.expand(r.$cached,e).getResult()}}});return l.resolve(o)}a=i.getPrivateAnnotation(s,"cache");if(!a){a=this.createGroupLevelCache(s);i.setPrivateAnnotation(s,"cache",a)}return a.read(0,this.iReadLength,0,t).then(function(t){var n=d.aElements.indexOf(s)+1,r=s["@$ui5.node.level"],l,u=d.oAggregation.subtotalsAtBottomOnly!==undefined,c;if(!s["@$ui5.node.isExpanded"]){i.deletePrivateAnnotation(s,"spliced");return 0}if(!n){i.setPrivateAnnotation(s,"expanding",true);return 0}o=t.value.$count;if(u){o+=1}if(n===d.aElements.length){d.aElements.length+=o}else{for(c=d.aElements.length-1;c>=n;c-=1){d.aElements[c+o]=d.aElements[c];delete d.aElements[c]}}d.addElements(t.value,n,a,0);for(c=n+t.value.length;c<n+t.value.$count;c+=1){d.aElements[c]=e.createPlaceholder(r+1,c-n,a)}if(u){l=Object.assign({},i.getPrivateAnnotation(s,"collapsed"));e.setAnnotations(l,undefined,true,r,e.getAllProperties(d.oAggregation));i.setPrivateAnnotation(l,"predicate",i.getPrivateAnnotation(s,"predicate").slice(0,-1)+",$isTotal=true)");d.addElements(l,n+o-1)}d.aElements.$count+=o;return o},function(e){i.updateAll(d.mChangeListeners,n,s,i.getPrivateAnnotation(s,"collapsed"));throw e})};s.prototype.fetchValue=function(e,t,n,r){if(t==="$count"){if(this.oAggregation.groupLevels.length){o.error("Failed to drill-down into $count, invalid segment: $count",this.toString(),"sap.ui.model.odata.v4.lib._Cache");return l.resolve()}return this.oFirstLevel.fetchValue(e,t,n,r)}this.registerChange(t,r);return this.drillDown(this.aElements,t,e)};s.prototype.read=function(t,n,r,a,o){var s,u=t,d=n,c,f,g=!!this.oGrandTotalPromise,h=g&&this.oAggregation.grandTotalAtBottomOnly!==true,p=[],v,m,E=this;function A(e,t){var n=c,r=i.getPrivateAnnotation(E.aElements[e],"index"),l=E.aElements[e];p.push(c.read(r,t-e,0,a.getUnlockedCopy(),o).then(function(t){var i=false,a;if(l!==E.aElements[e]&&t.value[0]!==E.aElements[e]){i=true;e=E.aElements.indexOf(l);if(e<0){e=E.aElements.indexOf(t.value[0]);if(e<0){a=new Error("Collapse before read has finished");a.canceled=true;throw a}}}E.addElements(t.value,e,n,r);if(i){a=new Error("Collapse or expand before read has finished");a.canceled=true;throw a}}))}if(h&&!t&&n===1){if(r!==0){throw new Error("Unsupported prefetch length: "+r)}a.unlock();return this.oGrandTotalPromise.then(function(e){return{value:[e]}})}else if(this.aElements.$count===undefined){this.iReadLength=n+r;if(h){if(u){u-=1}else{d-=1}}p.push(this.oFirstLevel.read(u,d,r,a,o).then(function(t){var n,r,a=0,o;E.aElements.length=E.aElements.$count=t.value.$count;if(g){E.aElements.$count+=1;E.aElements.length+=1;n=E.oGrandTotalPromise.getResult();switch(E.oAggregation.grandTotalAtBottomOnly){case false:a=1;E.aElements.$count+=1;E.aElements.length+=1;E.addElements(n,0);r=i.getPrivateAnnotation(n,"copy");E.addElements(r,E.aElements.length-1);break;case true:E.addElements(n,E.aElements.length-1);break;default:a=1;E.addElements(n,0)}}E.addElements(t.value,u+a,E.oFirstLevel,u);for(o=0;o<E.aElements.$count;o+=1){if(!E.aElements[o]){E.aElements[o]=e.createPlaceholder(1,o-a,E.oFirstLevel)}}}))}else{for(v=t,m=Math.min(t+n,this.aElements.length);v<m;v+=1){s=i.getPrivateAnnotation(this.aElements[v],"parent");if(s!==c){if(f){A(f,v);c=f=undefined}if(s){f=v;c=s}}}if(f){A(f,v)}a.unlock()}return l.all(p).then(function(){var e=E.aElements.slice(t,t+n);e.$count=E.aElements.$count;return{value:e}})};s.prototype.refreshKeptElements=function(){};s.prototype.toString=function(){return this.oRequestor.getServiceUrl()+this.sResourcePath+this.oRequestor.buildQueryString(this.sMetaPath,e.buildApply(this.oAggregation,this.mQueryOptions),false,true)};s.calculateKeyPredicate=function(t,n,r,a,o,l,s,u){var d;if(!(u in s)){return undefined}if(t){r.forEach(function(e){if(Array.isArray(e)){i.inheritPathValue(e,t,l)}else if(!(e in l)){l[e]=t[e]}})}d=a&&i.getKeyPredicate(l,u,s)||i.getKeyPredicate(l,u,s,n,true);i.setPrivateAnnotation(l,"predicate",d);if(!a){i.setPrivateAnnotation(l,"filter",i.getKeyFilter(l,u,s,n))}e.setAnnotations(l,a?undefined:false,o,t?t["@$ui5.node.level"]+1:1,t?null:r);return d};s.create=function(n,r,i,o,l,u,d){var c,f,g;if(o){f=e.hasGrandTotal(o.aggregate);g=e.hasMinOrMax(o.aggregate);c=o.groupLevels.length||f||g;if(c){if("$expand"in l){throw new Error("Unsupported system query option: $expand")}if("$select"in l){throw new Error("Unsupported system query option: $select")}if(g){return a.createCache(n,r,o,l)}return new s(n,r,o,f,l)}}if(l.$$filterBeforeAggregate){l.$apply="filter("+l.$$filterBeforeAggregate+")/"+l.$apply;delete l.$$filterBeforeAggregate}return t.create(n,r,l,u,i,d)};return s},false);