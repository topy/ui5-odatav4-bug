/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./ODataBinding","./lib/_Cache","./lib/_Helper","sap/base/Log","sap/ui/base/SyncPromise","sap/ui/model/BindingMode","sap/ui/model/ChangeReason","sap/ui/model/odata/v4/Context","sap/ui/model/PropertyBinding"],function(e,t,n,o,i,s,r,a,h){"use strict";var u="sap.ui.model.odata.v4.ODataPropertyBinding",d=Object.freeze([]),p={AggregatedDataStateChange:true,change:true,dataReceived:true,dataRequested:true,DataStateChange:true},l="/"+a.VIRTUAL;var f=h.extend("sap.ui.model.odata.v4.ODataPropertyBinding",{constructor:function(t,o,i,s){h.call(this,t,o);e.call(this);if(o.endsWith("/")){throw new Error("Invalid path: "+o)}if(s){this.checkBindingParameters(s,["$$groupId","$$ignoreMessages","$$noPatch"]);this.sGroupId=s.$$groupId;this.bNoPatch=s.$$noPatch;this.setIgnoreMessages(s.$$ignoreMessages)}else{this.sGroupId=undefined}this.oCheckUpdateCallToken=undefined;this.mQueryOptions=this.oModel.buildQueryOptions(n.clone(s),false);this.fetchCache(i);this.oContext=i;this.bHasDeclaredType=undefined;this.bInitial=true;this.vValue=undefined;t.bindingCreated(this)},metadata:{publicMethods:[]}});e(f.prototype);f.prototype.adjustPredicate=function(){};f.prototype.attachEvent=function(e){if(!(e in p)){throw new Error("Unsupported event '"+e+"': v4.ODataPropertyBinding#attachEvent")}return h.prototype.attachEvent.apply(this,arguments)};f.prototype.checkUpdateInternal=function(e,t,a,h){var d=false,p=this.sPath.indexOf("##"),f=p>=0,c=this.oModel.getMetaModel(),g={data:{}},y=this.oModel.resolve(this.sPath,this.oContext),C={forceUpdate:y&&(e||e===undefined&&this.getDataState().getControlMessages().length>0||this.oCheckUpdateCallToken&&this.oCheckUpdateCallToken.forceUpdate)},v=this.oType,M=this;this.oCheckUpdateCallToken=C;if(this.bHasDeclaredType===undefined){this.bHasDeclaredType=!!v}if(y&&!this.bHasDeclaredType&&this.sInternalType!=="any"&&!f){v=c.fetchUI5Type(y)}if(arguments.length<4){h=this.oCachePromise.then(function(e){var t,n;if(e){return e.fetchValue(M.lockGroup(a||M.getGroupId()),undefined,function(){d=true;M.fireDataRequested()},M).then(function(t){M.assertSameCache(e);return t})}if(!M.sReducedPath||!M.isResolved()){return undefined}if(y.includes(l)){C.forceUpdate=false}if(!f){return M.oContext.fetchValue(M.sReducedPath,M)}t=M.sPath.slice(0,p);n=M.sPath.slice(p+2);if(n[0]==="/"){n="."+n}return c.fetchObject(n,c.getMetaContext(M.oModel.resolve(t,M.oContext)))}).then(function(e){if(!e||typeof e!=="object"){return e}if(M.sInternalType==="any"&&(M.getBindingMode()===s.OneTime||M.sPath[M.sPath.lastIndexOf("/")+1]==="#"&&!f)){if(f){return e}else if(M.bRelative){return n.publicClone(e)}}o.error("Accessed value is not primitive",y,u)},function(e){M.oModel.reportError("Failed to read path "+y,u,e);if(e.canceled){C.forceUpdate=false;return M.vValue}g={error:e}});if(e&&h.isFulfilled()){if(v&&v.isFulfilled&&v.isFulfilled()){this.setType(v.getResult(),this.sInternalType)}this.vValue=h.getResult()}h=Promise.resolve(h)}return i.all([h,v]).then(function(e){var n=e[1],o=e[0];if(C===M.oCheckUpdateCallToken){M.oCheckUpdateCallToken=undefined;M.setType(n,M.sInternalType);if(C.forceUpdate||M.vValue!==o){M.bInitial=false;M.vValue=o;M._fireChange({reason:t||r.Change})}M.checkDataState()}if(d){M.fireDataReceived(g)}})};f.prototype.deregisterChange=function(){var e=this;this.withCache(function(t,n,o){o.doDeregisterChangeListener(n,e)}).catch(function(t){e.oModel.reportError("Error in deregisterChange",u,t)},"",false,true)};f.prototype.destroy=function(){this.deregisterChange();this.oModel.bindingDestroyed(this);this.oCheckUpdateCallToken=undefined;this.mQueryOptions=undefined;this.vValue=undefined;e.prototype.destroy.call(this);h.prototype.destroy.apply(this,arguments)};f.prototype.doCreateCache=function(e,n){return t.createProperty(this.oModel.oRequestor,e,n)};f.prototype.doFetchQueryOptions=function(){return this.isRoot()?i.resolve(this.mQueryOptions):i.resolve({})};f.prototype.getDependentBindings=function(){return d};f.prototype.getResumePromise=function(){};f.prototype.getValue=function(){return this.vValue};f.prototype.getValueListType=function(){var e=this.getModel().resolve(this.sPath,this.oContext);if(!e){throw new Error(this+" is unresolved")}return this.getModel().getMetaModel().getValueListType(e)};f.prototype.hasPendingChangesInDependents=function(){return false};f.prototype.initialize=function(){if(this.isResolved()){if(this.getRootBinding().isSuspended()){this.sResumeChangeReason=r.Change}else{this.checkUpdate(true)}}};f.prototype.isMeta=function(){return this.sPath.includes("##")};f.prototype.onChange=function(e){this.checkUpdateInternal(undefined,undefined,undefined,e)};f.prototype.refreshInternal=function(e,t,n){if(this.isRootBindingSuspended()){this.sResumeChangeReason=r.Refresh;return i.resolve()}this.fetchCache(this.oContext);return n?this.checkUpdateInternal(undefined,r.Refresh,t):i.resolve()};f.prototype.requestValue=function(){var e=this;return Promise.resolve(this.checkUpdateInternal(false).then(function(){return e.getValue()}))};f.prototype.requestValueListInfo=function(e){var t=this.getModel().resolve(this.sPath,this.oContext);if(!t){throw new Error(this+" is unresolved")}return this.getModel().getMetaModel().requestValueListInfo(t,e,this.oContext)};f.prototype.requestValueListType=function(){var e=this.getModel().resolve(this.sPath,this.oContext);if(!e){throw new Error(this+" is unresolved")}return this.getModel().getMetaModel().requestValueListType(e)};f.prototype.resetChangesInDependents=function(){};f.prototype.resetInvalidDataState=function(){if(this.getDataState().isControlDirty()){this._fireChange({reason:r.Change})}};f.prototype.resume=function(){throw new Error("Unsupported operation: resume")};f.prototype.resumeInternal=function(e,t){var n=this.sResumeChangeReason;this.sResumeChangeReason=undefined;this.fetchCache(this.oContext);if(e){this.checkUpdateInternal(t?undefined:false,n)}};f.prototype.setContext=function(e){if(this.oContext!==e){if(this.bRelative){this.deregisterChange()}this.oContext=e;this.sResumeChangeReason=undefined;if(this.bRelative){this.fetchCache(this.oContext);this.checkUpdateInternal(this.bInitial||undefined,r.Context)}}};f.prototype.setType=function(e,t){var n=this.oType;if(e&&e.getName()==="sap.ui.model.odata.type.DateTimeOffset"){e.setV4()}h.prototype.setType.apply(this,arguments);if(!this.bInitial&&n!==e){this._fireChange({reason:r.Change})}};f.prototype.setValue=function(e,t){var n,o=this;function i(e){o.oModel.reportError("Failed to update path "+o.oModel.resolve(o.sPath,o.oContext),u,e);return e}this.checkSuspended();if(this.bNoPatch&&t){throw i(new Error("Must not specify a group ID ("+t+") with $$noPatch"))}this.oModel.checkGroupId(t);if(typeof e==="function"||e&&typeof e==="object"){throw i(new Error("Not a primitive value"))}if(!this.bNoPatch&&this.vValue===undefined){throw i(new Error("Must not change a property before it has been read"))}if(this.vValue!==e){if(this.oCache){i(new Error("Cannot set value on this binding as it is not relative"+" to a sap.ui.model.odata.v4.Context"));return}n=this.bNoPatch?null:this.lockGroup(t,true,true);this.oContext.doSetProperty(this.sPath,e,n).catch(function(e){if(n){n.unlock(true)}i(e)})}};f.prototype.supportsIgnoreMessages=function(){return true};f.prototype.suspend=function(){throw new Error("Unsupported operation: suspend")};f.prototype.visitSideEffects=function(){};return f});