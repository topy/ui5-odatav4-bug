/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","./AccButton","./IconTabFilterExpandButtonBadge","sap/ui/core/library","sap/ui/core/Core","sap/ui/core/Item","sap/ui/core/Renderer","sap/ui/core/IconPool","sap/ui/core/InvisibleMessage","sap/ui/core/InvisibleText","sap/ui/Device","sap/m/BadgeCustomData","sap/m/Button","sap/m/ResponsivePopover","sap/m/IconTabBarSelectList","sap/m/BadgeEnabler"],function(e,t,i,s,o,a,n,r,l,p,g,d,c,h,u,f){"use strict";var _=s.TextAlign;var I=s.TextDirection;var v=e.ButtonType;var T=e.PlacementType;var b=e.ImageHelper;var B=e.IconTabFilterDesign;var m=e.BadgeStyle;var y=e.BadgeState;var C=s.IconColor;var x=3e3;var D=s.InvisibleMessageMode;var S=a.extend("sap.m.IconTabFilter",{metadata:{interfaces:["sap.m.IconTab","sap.ui.core.PopupInterface","sap.m.IBadge"],library:"sap.m",designtime:"sap/m/designtime/IconTabFilter.designtime",properties:{count:{type:"string",group:"Data",defaultValue:""},showAll:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:""},iconColor:{type:"sap.ui.core.IconColor",group:"Appearance",defaultValue:C.Default},iconDensityAware:{type:"boolean",group:"Appearance",defaultValue:true},visible:{type:"boolean",group:"Behavior",defaultValue:true},design:{type:"sap.m.IconTabFilterDesign",group:"Appearance",defaultValue:B.Vertical}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},items:{type:"sap.m.IconTab",multiple:true,singularName:"item"},_expandButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"},_expandButtonBadge:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}}}});f.call(S.prototype);var E=o.getLibraryResourceBundle("sap.m");S._aAllIconColors=["sapMITBFilterCritical","sapMITBFilterPositive","sapMITBFilterNegative","sapMITBFilterDefault","sapMITBFilterNeutral"];S.prototype._getImageControl=function(e,t,i){var s={src:this.getIcon(),densityAware:this.getIconDensityAware(),useIconTooltip:false};if(s.src){this._oImageControl=b.getImageControl(this.getId()+"-icon",this._oImageControl,t,s,e,i)}else if(this._oImageControl){this._oImageControl.destroy();this._oImageControl=null}return this._oImageControl};S.prototype.init=function(){this._oDragEventDelegate={onlongdragover:this._handleOnLongDragOver,ondragover:this._handleOnDragOver,ondragleave:this._handleOnDragLeave,ondrop:this._handleOnDrop};this.initBadgeEnablement({style:m.Attention,selector:{selector:".sapMITBBadgeHolder"}});this._oCloneInList=null;this.setAggregation("_expandButtonBadge",new i)};S.prototype.exit=function(e){if(this._oImageControl){this._oImageControl.destroy()}if(a.prototype.exit){a.prototype.exit.call(this,e)}if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null}if(this._oPopover){this._oPopover.destroy();this._oPopover=null}if(this._oExpandButton){this._oExpandButton.removeEventDelegate(this._oDragEventDelegate);this._oExpandButton.destroy();this._oExpandButton=null}this.removeEventDelegate(this._oDragEventDelegate);this._oDragEventDelegate=null;if(this._iHideBadgeTimeout){clearTimeout(this._iHideBadgeTimeout)}};S.prototype.invalidate=function(){var e=this.getParent(),t,i;if(!e){return}t=e.getParent();if(!(t instanceof sap.m.IconTabBar)){e.invalidate();return}i=t.getParent();if(i instanceof sap.m.ObjectHeader){i.invalidate()}else{t.invalidate()}};S.prototype.setProperty=function(e,t,i){switch(e){case"textDirection":case"text":case"count":case"showAll":case"icon":case"iconColor":case"iconDensityAware":case"design":if(this.getProperty(e)===t){return this}a.prototype.setProperty.call(this,e,t,true);if(!i){var s=this.getParent();if(s instanceof sap.m.IconTabHeader){s.invalidate()}}break;default:a.prototype.setProperty.apply(this,arguments);break}return this};S.prototype._getNonEmptyKey=function(){var e=this.getKey();if(e){return e}return this.getId()};S.prototype._getRealTab=function(){return this._oRealItem||this};S.prototype._getRootTab=function(){var e=this._getRealTab(),t=e.getParent();while(t&&t.isA("sap.m.IconTabFilter")){e=t;t=t.getParent()}return e};S.prototype._getNestedLevel=function(){var e=this._getRealTab().getParent(),t;for(t=1;e&&e.isA("sap.m.IconTabFilter");t++){e=e.getParent()}return t};S.prototype.render=function(e,t,i){if(!this.getVisible()){return}this._prepareDragEventDelegate();var s=this.getParent(),o=s.getParent(),a=s._isInsideIconTabBar(),n={role:"tab"},l=this.getId(),p=this.getCount(),g=this.getText(),d=this.getIcon(),c=this.getIconColor(),h=this.getEnabled(),u=h&&(c=="Positive"||c=="Critical"||c=="Negative"||c=="Neutral"),f=this.getDesign()===B.Horizontal,_=s._bTextOnly,I=s._bInLine||s.isInlineMode(),v=this.getShowAll();if(a){n.controls=o.getId()+"-content"}if(this.getItems().length){n.roledescription=E.getText("ICONTABFILTER_SPLIT_TAB")}if(g.length||p!==""||d){var T=[];if(p!==""){T.push(l+"-count")}if(g.length){T.push(l+"-text")}if(d){T.push(l+"-icon")}if(u){T.push(l+"-iconColor")}n.labelledby=T.join(" ")}if(t!==undefined&&i!==undefined){Object.assign(n,{posinset:t+1,setsize:i})}e.openStart("div",this).accessibilityState(n).class("sapMITBItem");if(!p){e.class("sapMITBItemNoCount")}if(f){e.class("sapMITBHorizontal")}else{e.class("sapMITBVertical")}if(v){e.class("sapMITBAll")}else{e.class("sapMITBFilter")}if(!v&&h){e.class("sapMITBFilter"+c)}if(s._isUnselectable(this)){e.class("sapMITHUnselectable")}if(this.getItems().length>0){e.class("sapMITBFilterWithItems")}if(!h){e.class("sapMITBDisabled").attr("aria-disabled",true)}e.attr("aria-selected",false);var b=this.getTooltip_AsString();if(b){e.attr("title",b)}if(this._bIsOverflow||this.getItems().length){e.attr("aria-haspopup","menu")}e.openEnd();e.openStart("div").class("sapMITBFilterWrapper").openEnd();if(!I){e.openStart("div",l+"-tab").class("sapMITBTab").openEnd();if(!v||!d){if(u){e.openStart("div",l+"-iconColor").style("display","none").openEnd().text(E.getText("ICONTABBAR_ICONCOLOR_"+c.toUpperCase())).close("div")}var m=["sapMITBFilterIcon","sapMITBBadgeHolder"];if(h){m.push("sapMITBFilter"+c)}e.renderControl(this._getImageControl(m,s,S._aAllIconColors))}if(!v&&!d&&!_){e.openStart("span").class("sapMITBFilterNoIcon").openEnd().close("span")}if(f&&!v){e.close("div");e.openStart("div").class("sapMITBHorizontalWrapper").openEnd()}e.openStart("span",l+"-count").class("sapMITBCount");if(v||!d&&!g.length){e.class("sapMITBBadgeHolder")}e.openEnd();if(p===""&&f){e.unsafeHtml("&nbsp;")}else{e.text(p)}e.close("span");if(!f){e.close("div")}}if(g.length){e.openStart("div",l+"-text").class("sapMITBText");if(a&&o.getUpperCase()){e.class("sapMITBTextUpperCase")}if(I){e.attr("dir","ltr")}e.openEnd();e.openStart("span").class("sapMITHTextContent");if(!d&&!v){e.class("sapMITBBadgeHolder")}e.openEnd();e.text(s._getDisplayText(this));e.close("span");if(this._bIsOverflow||this.getItems().length&&s._isUnselectable(this)){e.openStart("span",this.getId()+"-expandButton").class("sapMITHShowSubItemsIcon").openEnd();e.icon(r.getIconURI("slim-arrow-down"),null,{title:null,"aria-hidden":true});e.close("span")}e.close("div")}if(!I&&f){e.close("div")}e.openStart("div").class("sapMITBContentArrow").openEnd().close("div");e.close("div");if(this.getItems().length&&!s._isUnselectable(this)){e.openStart("span").accessibilityState({role:"separator"}).openEnd().close("span");e.renderControl(this._getExpandButton())}e.renderControl(this.getAggregation("_expandButtonBadge"));if(this.getItems().length){this._updateExpandButtonBadge()}e.close("div")};S.prototype.renderInSelectList=function(e,t,i,s,o){if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null}if(!this.getVisible()){return}var a=true,n=t._bIconOnly,r=t._oIconTabHeader,l=this.getIconColor(),g=this.getEnabled();if(r){a=r._bTextOnly}e.openStart("li",this).class("sapMITBSelectItem").attr("tabindex","-1").attr("role","menuitem");if(o){e.style("padding-left",o+"rem")}if(i!==undefined&&s!==undefined){e.attr("aria-posinset",i+1);e.attr("aria-setsize",s);e.attr("aria-level",this._getNestedLevel())}var d=this.getTooltip_AsString();if(d){e.attr("title",d)}if(r._isUnselectable(this)){e.class("sapMITHUnselectable")}if(!g){e.class("sapMITBDisabled").attr("aria-disabled",true)}if(t.getSelectedItem()==this){e.class("sapMITBSelectItemSelected");e.attr("aria-selected",true)}if(g){e.class("sapMITBFilter"+l)}var c=this.getId(),h=g&&(l=="Positive"||l=="Critical"||l=="Negative"||l=="Neutral"),u=[];if(!n){u.push(c+"-text")}if(!a&&this.getIcon()){u.push(c+"-icon")}if(h){this._invisibleText=new p({text:E.getText("ICONTABBAR_ICONCOLOR_"+l.toUpperCase())});u.push(this._invisibleText.getId())}e.accessibilityState({labelledby:u.join(" ")}).openEnd();if(this._invisibleText){e.renderControl(this._invisibleText)}if(!a){this._renderIcon(e,n)}if(!n){this._renderText(e)}e.close("li")};S.prototype._onAfterParentRendering=function(){this._renderBadge();l.getInstance()};S.prototype._renderIcon=function(e,t){var i=this.getIcon();if(i){var s=r.getIconInfo(i),o=["sapMITBSelectItemIcon"];if(s&&!s.suppressMirroring){o.push("sapUiIconMirrorInRTL")}if(t){o.push("sapMITBBadgeHolder")}e.icon(i,o,{id:this.getId()+"-icon","aria-hidden":true})}else{e.openStart("span").class("sapUiIcon").openEnd().close("span")}};S.prototype._renderText=function(e){var t=this.getText(),i=this.getCount(),s=o.getConfiguration().getRTL(),a=this.getTextDirection();e.openStart("span",this.getId()+"-text").attr("dir","ltr").class("sapMText").class("sapMTextNoWrap").class("sapMITBText").class("sapMITBBadgeHolder");if(a!==I.Inherit){e.attr("dir",a.toLowerCase())}var r=n.getTextAlign(_.Begin,a);if(r){e.style("text-align",r)}if(i){if(s){t="("+i+") "+t}else{t+=" ("+i+")"}}e.openEnd().text(t).close("span")};S.prototype._getSelectList=function(){if(!this._oSelectList){this._oSelectList=new u({selectionChange:function(e){var t=e.getParameter("selectedItem");this._oIconTabHeader.setSelectedItem(t._getRealTab());this._oTabFilter._closePopover()}});this._oSelectList._oIconTabHeader=this.getParent();this._oSelectList._oTabFilter=this;this._oSelectList._bIsOverflow=this._bIsOverflow}return this._oSelectList};S.prototype._prepareDragEventDelegate=function(){if(this.getEnabled()){this.addEventDelegate(this._oDragEventDelegate,this)}else{this.removeEventDelegate(this._oDragEventDelegate)}};S.prototype._getExpandButton=function(){this._oExpandButton=this.getAggregation("_expandButton");if(!this._oExpandButton){this._oExpandButton=new t(this.getId()+"-expandButton",{type:v.Transparent,icon:r.getIconURI("slim-arrow-down"),tooltip:E.getText("ICONTABHEADER_OVERFLOW_MORE"),tabIndex:"-1",press:this._expandButtonPress.bind(this)}).addStyleClass("sapMITBFilterExpandBtn");this.setAggregation("_expandButton",this._oExpandButton)}return this._oExpandButton};S.prototype._updateExpandButtonBadge=function(){var e=this.getAggregation("_expandButtonBadge"),t=e.getBadgeCustomData()&&e.getBadgeCustomData().getVisible(),i=this._hasChildWithBadge();if(i&&!t){e.addCustomData(new d({visible:true}))}else if(!i&&t){e.getBadgeCustomData().setVisible(false)}};S.prototype._hasChildWithBadge=function(){var e=this._bIsOverflow?this._getIconTabHeader()._getItemsForOverflow():this._getAllSubItems();return e.some(function(e){return e.isA("sap.m.IBadge")&&e.getBadgeCustomData()&&e.getBadgeCustomData().getVisible()})};S.prototype._expandButtonPress=function(){if(!this.getEnabled()){return}this.$().trigger("focus");if(!this._oPopover){this._oPopover=new h({showArrow:false,showHeader:false,offsetY:0,offsetX:0,placement:T.VerticalPreferredBottom}).addStyleClass("sapMITBFilterPopover");this._oPopover.attachBeforeClose(function(){this._getSelectList().destroyItems()},this);if(g.system.phone){this._oPopover._oControl.addButton(this._createPopoverCloseButton())}this.addDependent(this._oPopover);this._oPopover._oControl._adaptPositionParams=function(){var e=this.$().parents().hasClass("sapUiSizeCompact");this._arrowOffset=0;if(e){this._offsets=["0 0","0 0","0 4","0 0"]}else{this._offsets=["0 0","0 0","0 5","0 0"]}this._atPositions=["end top","end top","end bottom","begin top"];this._myPositions=["end bottom","begin top","end top","end top"]}}var e=this._setSelectListItems();var t=this._getSelectList();this._oPopover.removeAllContent();if(this.getItems().length||this._bIsOverflow){this._oPopover.addContent(t);this._oPopover.setInitialFocus(e?t.getSelectedItem():t.getVisibleTabFilters()[0]);this._oPopover.openBy(this)}};S.prototype._getAllSubItems=function(){var e=[];this._getRealTab().getItems().forEach(function(t){if(t.isA("sap.m.IconTabFilter")){e=e.concat(t,t._getAllSubItems())}else{e=e.concat(t)}});return e};S.prototype._getAllSubFilters=function(){return this._getAllSubItems().filter(function(e){return e.isA("sap.m.IconTabFilter")})};S.prototype._getAllSubFiltersDomRefs=function(){return this._getAllSubFilters().filter(function(e){return Boolean(e._getRealTab().getDomRef())}).map(function(e){return e._getRealTab().getDomRef()})};S.prototype._getFirstAvailableSubFilter=function(){var e=this._getAllSubFilters();for(var t=0;t<e.length;t++){var i=e[t];if(i.getContent().length&&i.getVisible()){return i}}return this};S.prototype._isParentOf=function(e){var t=this._getAllSubFilters();for(var i=0;i<t.length;i++){if(t[i]._getRealTab()===e){return true}}return false};S.prototype._createPopoverCloseButton=function(){return new c({text:E.getText("SELECT_CANCEL_BUTTON"),press:this._closePopover.bind(this)})};S.prototype._closePopover=function(){if(this._oPopover){this._oPopover.close();this._oPopover.removeAllContent()}if(this._bIsOverflow&&this.getParent().oSelectedItem){(this.getParent()._oSelectedRootItem||this.getParent().oSelectedItem).$().focus()}};S.prototype._handleOnDragOver=function(e){if(this._isDropPossible(e)){this.getDomRef().classList.add("sapMITHDragOver");e.preventDefault()}};S.prototype._handleOnLongDragOver=function(e){if(this._isDropPossible(e)){if(this._oPopover&&this._oPopover.isOpen()){return}this._expandButtonPress()}};S.prototype._handleOnDrop=function(){this.getDomRef().classList.remove("sapMITHDragOver")};S.prototype._handleOnDragLeave=function(){this.getDomRef().classList.remove("sapMITHDragOver")};S.prototype._isDropPossible=function(e){var t=this._getIconTabHeader(),i=e.dragSession.getDragControl()._getRealTab(),s=t.oSelectedItem;if(t!==i._getIconTabHeader()){return false}if(i===this||i._isParentOf(this)){return false}if(!this._bIsOverflow&&!t.getMaxNestingLevel()){return false}if(this._bIsOverflow&&s&&(s===i||s._getRootTab()===i)){return false}return true};S.prototype._setSelectListItems=function(){var e=this.getParent(),t=this._getSelectList(),i=this._getAllSubItems(),s=e.oSelectedItem,o=false,a,n,r,l,p;if(this._bIsOverflow){i=e._getItemsForOverflow()}t.destroyItems();t.setSelectedItem(null);for(l=0;l<i.length;l++){a=i[l];n=a.clone(undefined,undefined,{cloneChildren:false,cloneBindings:true});a._oCloneInList=n;r=a.getCustomData();for(p=0;p<r.length;p++){n.addCustomData(r[p].clone())}n._oRealItem=a;t.addItem(n);if(a.isA("sap.m.IconTabSeparator")){continue}if(n._getRealTab()===s){t.setSelectedItem(n);o=true;continue}if(n._getRealTab()._isParentOf(s)){t.setSelectedItem(s._getRealTab());o=true}}return o};S.prototype._getIconTabHeader=function(){return this._getRootTab().getParent()};S.prototype.onsapdown=function(e){if(!this.getEnabled()){return}if(this._bIsOverflow||this._getNestedLevel()===1&&this._getRealTab()===this&&this._getRealTab().getItems().length!==0){e.stopImmediatePropagation();this._expandButtonPress()}};S.prototype._startBadgeHiding=function(){if(this._iHideBadgeTimeout){return}this._iHideBadgeTimeout=setTimeout(this._hideBadge.bind(this),x);if(this._getRootTab()!==this){this._getRootTab()._updateExpandButtonBadge()}};S.prototype._hideBadge=function(){var e=this.getBadgeCustomData();if(!e){return}e.setVisible(false);if(this._getRootTab()!==this){this._getRootTab()._updateExpandButtonBadge()}if(this._oCloneInList&&!this._oCloneInList.bIsDestroyed&&this._oCloneInList.getBadgeCustomData()){this._oCloneInList.getBadgeCustomData().setVisible(false);this._oCloneInList=null}if(this._isInOverflow()){this._getIconTabHeader()._getOverflow()._updateExpandButtonBadge()}this._iHideBadgeTimeout=null};S.prototype._isInOverflow=function(){return!this._bIsOverflow&&this._getIconTabHeader()._getItemsInStrip().indexOf(this._getRealTab())===-1};S.prototype.onBadgeUpdate=function(e,t,i){var s=this.getDomRef(),o=this._getIconTabHeader(),a,n,r,p,g,c,h;if(!o){return}if(s){r=s.getAttribute("aria-labelledby")||"";switch(t){case y.Appear:r=i+" "+r;break;case y.Disappear:r=r.replace(i,"").trim();break}s.setAttribute("aria-labelledby",r)}if(!o._isRendered()){return}a=this._getRootTab();if(a._isInOverflow()){g=this._getIconTabHeader()._getOverflow();g._updateExpandButtonBadge()}else if(a!==this){a._updateExpandButtonBadge()}if(t!==y.Appear){return}this._enableMotion();if(this._isInOverflow()&&this._oCloneInList){this._oCloneInList.addCustomData(new d)}n=l.getInstance();p=this.getText();if(a._isInOverflow()){c="ICONTABFILTER_SUB_ITEM_BADGE";h=[p,g.getText()]}else{if(a!==this){c="ICONTABFILTER_SUB_ITEM_BADGE";h=[p,a.getText()]}else{c="ICONTABFILTER_BADGE_MSG";h=p}}n.announce(E.getText(c,h),D.Assertive)};S.prototype.getAriaLabelBadgeText=function(){return E.getText("ICONTABFILTER_BADGE")};S.prototype._enableMotion=function(){if(this._getRealTab()._isInOverflow()){if(this._oCloneInList&&this._oCloneInList.getDomRef()){this._oCloneInList.getDomRef().classList.add("sapMITBFilterBadgeMotion")}}else if(this.getDomRef()){this.getDomRef().classList.add("sapMITBFilterBadgeMotion")}};return S});