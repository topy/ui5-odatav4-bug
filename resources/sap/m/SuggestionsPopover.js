/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/Device","sap/ui/base/EventProvider","sap/ui/core/InvisibleText","sap/ui/core/ValueStateSupport","sap/m/library","sap/ui/core/library","sap/m/Button","sap/m/GroupHeaderListItem","sap/m/List","sap/m/ValueStateHeader","sap/m/inputUtils/scrollToItem","sap/m/inputUtils/SuggestionsPopoverDialogMixin","sap/m/inputUtils/SuggestionsPopoverPopoverMixin","sap/m/inputUtils/ListHelpers"],function(t,e,a,s,o,i,n,r,u,l,p,d,h,c){"use strict";var S=o.ListMode;var g=o.ListSeparators;var f="sapMSuggestionsPopover",v="sapUiNoContentPadding";var y=i.ValueState;var m=e.extend("sap.m.SuggestionsPopover",{constructor:function(a){e.apply(this,arguments);this._oInput=a;this._sPopoverContentWidth=null;this._sOldValueState=y.None;this._oInput.addEventDelegate({onsaptabnext:this._handleValueStateLinkNav,onsaptabprevious:this._handleValueStateLinkNav},this);if(t.system.phone){d.apply(m.prototype)}else{h.apply(m.prototype)}},destroy:function(){this._destroySuggestionPopup()}});m.M_EVENTS={SELECTION_CHANGE:"selectionChange"};m.prototype.isOpen=function(){var t=this.getPopover();return t&&t.isOpen()};m.prototype.setPopover=function(t){this._oPopover=t};m.prototype.getPopover=function(){return this._oPopover};m.prototype.destroyPopover=function(){if(this._oPopover){this._oPopover.destroy()}this._oPopover=null};m.prototype.setInputLabels=function(t){this._fnInputLabels=t};m.prototype.createSuggestionPopup=function(t){var e,s=this._oInput,o=this.getItemsContainer();t=t||[];e=this.createPopover(s,t);this.setPopover(e);e.addStyleClass(f);e.addStyleClass(v);e.addAriaLabelledBy(a.getStaticId("sap.m","INPUT_AVALIABLE_VALUES"));if(o){this.addContent(o)}};m.prototype.initContent=function(e){var a=e,s=this._oInput,o=this.getPopover();if(!o){return}if(!a){a=new u(s.getId()+"-popup-list",{showNoData:false,mode:S.SingleSelectMaster,rememberSelections:false,width:"100%",showSeparators:g.None,busyIndicatorDelay:0})}if(t.system.phone){o.addAggregation("content",a,true);var i=o.$("scrollCont")[0];if(i){var n=sap.ui.getCore().createRenderManager();n.renderControl(a);n.flush(i);n.destroy()}}else{this.addContent(a)}};m.prototype._destroySuggestionPopup=function(){this.destroyPopover();this._oValueStateHeader=null};m.prototype.addContent=function(t){this.getPopover().addContent(t)};m.prototype.getItemsContainer=function(){var t=this.getPopover(),e=t&&t.getContent();return e&&e.filter(function(t){return t.isA("sap.m.List")&&t.getId().indexOf("-popup-list")>-1||t.isA("sap.m.Table")})[0]};m.prototype.handleListNavigation=function(e){var a=this._oInput,s=this.getPopover();if(e.isMarked()){return}if(!a.getEnabled()||!a.getEditable()){return}if(!s||!s.isOpen()){return}e.preventDefault();e.stopPropagation();var o=this.getItemsContainer(),i=this._getValueStateHeader(),n=i&&i.getVisible(),r=a.hasStyleClass("sapMFocus"),u=o&&o.getItems().filter(function(t){return t.getVisible&&t.getVisible()}),l=u.indexOf(this.getFocusedListItem()),d;switch(e.type){case"sapdown":d=this.handleArrowDown(u,l,r,n);break;case"sapup":d=this.handleArrowUp(u,l,r,n);break;case"sapend":d=this.handleEnd(u,n);break;case"saphome":d=this.handleHome(u,n);break;case"sappagedown":d=this.handlePageDown(u,l,n);break;case"sappageup":d=this.handlePageUp(u,l,n);break}this.updateFocus(d);if(a.handleSelectionFromList){a.handleSelectionFromList(d)}else{this.handleSelectionFromList(d)}this.updateAriaActiveDescendant(d);if(t.system.desktop&&d){p(d,this.getPopover())}};m.prototype.handleArrowDown=function(t,e,a,s){if(a&&!s){return t[0]}if(!a&&!this.getValueStateActiveState()){if(e===t.length-1){return t[e]}return t[e+1]}if(this.getValueStateActiveState()){this.setValueStateActiveState(false);return t[0]}else{this.setValueStateActiveState(true)}};m.prototype.handleArrowUp=function(t,e,a,s){if(a){return}if(e>0){return t[e-1]}if(s){this.setValueStateActiveState(!this.getValueStateActiveState())}};m.prototype.handleEnd=function(t,e){if(e){this.setValueStateActiveState(false)}return t.length&&t[t.length-1]};m.prototype.handleHome=function(t,e){if(e){this.setValueStateActiveState(true);return}return t.length&&t[0]};m.prototype.handlePageDown=function(t,e,a){if(a){this.setValueStateActiveState(false)}return t[Math.min(t.length-1,e+10)]};m.prototype.handlePageUp=function(t,e,a){if(e-10>=0){return t[e-10]}if(a){this.setValueStateActiveState(true);return}return t[0]};m.prototype.updateFocus=function(t){var e=this._oInput,a=this.getItemsContainer(),s=this.getFocusedListItem(),o=this._getValueStateHeader(),i=o&&o.getVisible();a&&a.removeStyleClass("sapMListFocus");s&&s.removeStyleClass("sapMLIBFocused");e.hasStyleClass("sapMFocus")&&e.removeStyleClass("sapMFocus");i&&o.removeStyleClass("sapMPseudoFocus");if(t){t.addStyleClass("sapMLIBFocused");a.addStyleClass("sapMListFocus")}else if(this.getValueStateActiveState()){o.addStyleClass("sapMPseudoFocus")}else{e.addStyleClass("sapMFocus")}};m.prototype.handleSelectionFromList=function(t){var e=this._oInput,a=this.getItemsContainer(),s=false,o;if(!t||t.isA("sap.m.GroupHeaderListItem")){a.removeSelections(true)}else{a.setSelectedItem(t,true);this._bSuggestionItemChanged=true}if(!t||t.isA("sap.m.GroupHeaderListItem")){o=""}else if(t.isA("sap.m.ColumnListItem")){o=e._getInputValue(e._fnRowResultFilter(t))}else{o=e._getInputValue(t.getTitle())}if(!t&&e.isA("sap.m.Input")){o=e._sTypedInValue;s=true}this.fireEvent(m.M_EVENTS.SELECTION_CHANGE,{newValue:o,preventSelection:s})};m.prototype.updateAriaActiveDescendant=function(t){var e=this._oInput,a=e.getFocusDomRef(),s=this._getValueStateHeader(),o=s&&s.getFormattedText(),i;if(e.hasStyleClass("sapMFocus")){a.removeAttribute("aria-activedescendant");return}if(t){a.setAttribute("aria-activedescendant",t.getId());return}if(this.getValueStateActiveState()){i=o?o.getId():s.getId();a.setAttribute("aria-activedescendant",i)}};m.prototype.getFocusedListItem=function(){var t=this.getItemsContainer(),e=t&&t.getItems()||[];for(var a=0;a<e.length;a++){if(e[a].hasStyleClass("sapMLIBFocused")){return e[a]}}};m.prototype._getValueStateHeader=function(){var t;if(!this._oValueStateHeader){this._oValueStateHeader=new l;t=this.getPopover();if(t.isA("sap.m.Popover")){t.setCustomHeader(this._oValueStateHeader)}else{t.insertContent(this._oValueStateHeader,0)}this._oValueStateHeader.setPopup(t)}return this._oValueStateHeader};m.prototype.setValueStateActiveState=function(t){this.bMessageValueStateActive=t};m.prototype.getValueStateActiveState=function(){return this.bMessageValueStateActive};m.prototype.updateValueState=function(t,e,a){var o=a&&t!==y.None;e=e||s.getAdditionalText(t);if(!this.getPopover()){return this}if(this.getInput()){this.getInput().setValueState(t)}this._getValueStateHeader().setValueState(t);if(this._oValueStateHeader&&typeof e==="string"){this._oValueStateHeader.setText(e)}else if(this._oValueStateHeader&&typeof e==="object"){this._oValueStateHeader.setFormattedText(e)}if(this._oValueStateHeader){this._oValueStateHeader.setVisible(o)}this._alignValueStateStyles(t);return this};m.prototype._handleValueStateLinkNav=function(t){if(!this.getValueStateActiveState()||this.getValueStateActiveState()&&document.activeElement.tagName==="A"){return}var e=this.getValueStateLinks(),a=e[e.length-1];t.preventDefault();e[0].focus();this._getValueStateHeader().removeStyleClass("sapMPseudoFocus");e.forEach(function(t){t.addDelegate({onsapup:function(t){this._oInput.getFocusDomRef().focus();this.handleListNavigation(t)},onsapdown:function(t){this._oInput.getFocusDomRef().focus();this.handleListNavigation(t)}},this)},this);a.addDelegate({onsaptabnext:function(t){this.setValueStateActiveState(false);this._oInput.onsapfocusleave(t);this.getPopover().close();setTimeout(function(){this._oInput.closeValueStateMessage()}.bind(this),0)}},this);e[0].addDelegate({onsaptabprevious:function(t){t.preventDefault();this._oInput.getFocusDomRef().focus();this._getValueStateHeader().addStyleClass("sapMPseudoFocus");this._oInput.removeStyleClass("sapMFocus")}},this)};m.prototype.getValueStateLinks=function(){var t=this._getValueStateHeader(),e=t&&typeof t.getFormattedText==="function"&&t.getFormattedText(),a=e&&typeof e.getControls==="function"&&e.getControls();return a||[]};m.prototype._alignValueStateStyles=function(t){var e=f+"ValueState",a=f+this._sOldValueState+"State",s=f+t+"State",o=this.getPopover();o.addStyleClass(e);o.removeStyleClass(a);o.addStyleClass(s);this._sOldValueState=t};m.prototype.getInput=function(){return null};m.prototype.getPickerTitle=function(){return null};m.prototype.getOkButton=function(){return null};m.prototype.getCancelButton=function(){return null};m.prototype.getFilterSelectedButton=function(){return null};m.prototype.setOkPressHandler=function(){return null};m.prototype.setCancelPressHandler=function(){return null};m.prototype.setShowSelectedPressHandler=function(){return null};m.prototype.resizePopup=function(){};return m});